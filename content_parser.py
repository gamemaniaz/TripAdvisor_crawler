import csv, re, requests
from bs4 import BeautifulSoup


def read_file():
    """ read hotel information generated by url_parser.py """
    with open('data/hotels.csv', 'r') as f:
        reader = csv.DictReader(f)
        hotels = [dict(line) for line in reader]
    return hotels


def write_file(hotels):
    """ write extended hotel information """
    with open('data/hotel_ratings.csv', 'w', newline='') as csvfile:
        fieldnames = ['id', 'hotel_name', 'n_comment', 'rank_in_country', 'url', 'excellent', 'good', 'average', 'poor', 'terrible']
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        writer.writeheader()
        for hotel in hotels:
            writer.writerow(hotel)


def main():

    hotels = read_file()

    for hotel in hotels:
        
        print('Scraping Hotel', hotel['id'])
        soup = BeautifulSoup(requests.get(hotel['url']).text, 'html.parser')

        # extracting hotel ratings
        ratings = [tag.text for tag in soup.find_all('span', {'class': 'hotels-review-list-parts-ReviewRatingFilter__row_num--gIW_f'})]
        if not ratings: ratings = [tag.text for tag in soup.find_all('span', {'class': 'row_num is-shown-at-tablet'})]

        hotel['excellent'] = int(ratings[0].replace(',',''))
        hotel['good'] = int(ratings[1].replace(',',''))
        hotel['average'] = int(ratings[2].replace(',',''))
        hotel['poor'] = int(ratings[3].replace(',',''))
        hotel['terrible'] = int(ratings[4].replace(',',''))

    write_file(hotels)


if __name__ == "__main__":
    main()